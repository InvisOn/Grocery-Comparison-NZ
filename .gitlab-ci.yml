stages:
  - setup
  - lint
  - test
  - test-coverage
  # - e2e

setup:
  stage: setup
  image: node:22.12.0
  script:
    - npm run install-everything
  artifacts:
    paths:
      - node_module/
      - server/
      - client/
    when: on_success

eslint:
  stage: lint
  image: node:22.12.0
  script:
    - npm run lint
  only:
    - merge_requests
    - branches

test_coverage_client:
  stage: test-coverage
  image: node:22.12.0
  script:
    - cd client
    # If using Jest for the React + Ionic project:
    - npx jest --ci --coverage
    # Make sure jest.config.js is configured to output to coverage/
  coverage: '/All files[^\|]*\|[^\|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        # Path to the Cobertura file. Adjust if needed.
        path: client/coverage/cobertura-coverage.xml
    paths:
      - client/coverage/

test_coverage_server:
  stage: test-coverage
  image: node:22.12.0
  script:
    - cd server
    # If using Jest for the Node.js + Express.js project:
    - npx jest --ci --coverage
    # Or Mocha + nyc, as long as the output is in Cobertura XML format
  coverage: '/All files[^\|]*\|[^\|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: server/coverage/cobertura-coverage.xml
    paths:
      - server/coverage/

client-test:
  stage: test
  image: node:22.12.0
  script:
    - cd client
    - npm run test

server-test:
  stage: test
  image: node:22.12.0
  script:
    - cd server
    - npm run test

# Step 4: client End-to-End Tests with Maestro
# client-e2e-maestro:
#   stage: e2e
#   image: maestroqa/maestro-cli:latest
#   before_script:
#     - mkdir -p maestro-artifacts
#     - export ANDROID_HOME=/sdk/android
#   script:
#     - maestro test mobile/maestro/register_test.yaml --output maestro-artifacts
#   artifacts:
#     paths:
#       - maestro-artifacts/
#     when: always

# Step 5: server End-to-End Tests with Cypress
# server-e2e-cypress:
#   stage: e2e
#   image: cypress/included:12.6.0
#   script:
#     - cypress run --config-file cypress.json
#   artifacts:
#     paths:
#       - cypress/results/
#     when: always
