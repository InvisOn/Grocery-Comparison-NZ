stages:
  - setup
  - lint
  - test
  - test-coverage-frontend
  - test-coverage-backend
  # - e2e

setup:
  stage: setup
  image: node:22.12.0
  script:
    - npm run install-everything
  artifacts:
    paths:
      - server/
      - client/
    when: on_success

eslint:
  stage: lint
  image: node:22.12.0
  script:
    - npm run lint
    - npm ci
    - npx eslint --format gitlab .
  artifacts:
    reports:
      codequality: gl-codequality.json
  only:
    - merge_requests
    - branches

client-test:
  stage: test
  image: node:22.12.0
  script:
    - cd client
    - npm run test

server-test:
  stage: test
  image: node:22.12.0
  script:
    - cd server
    - npm run test



# 3) Test and Generate Coverage Reports
test_coverage_frontend:
  stage: test-coverage-frontend
  image: node:22.12.0
  needs:
    - setup
  script:
    - cd frontend
    # If using Jest for the React + Ionic project:
    - npm run test -- --coverage --coverageReporters=cobertura
    # Make sure jest.config.js is configured to output to coverage/
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        # Path to the Cobertura file. Adjust if needed.
        path: frontend/coverage/cobertura-coverage.xml
    paths:
      - frontend/coverage/

test_coverage_backend:
  stage: test-coverage-backend
  image: node:22.12.0
  needs:
    - setup
  script:
    - cd backend
    # If using Jest for the Node.js + Express.js project:
    - npm run test -- --coverage --coverageReporters=cobertura
    # Or Mocha + nyc, as long as the output is in Cobertura XML format
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage/cobertura-coverage.xml
    paths:
      - backend/coverage/

# Step 4: client End-to-End Tests with Maestro
# client-e2e-maestro:
#   stage: e2e
#   image: maestroqa/maestro-cli:latest
#   before_script:
#     - mkdir -p maestro-artifacts
#     - export ANDROID_HOME=/sdk/android
#   script:
#     - maestro test mobile/maestro/register_test.yaml --output maestro-artifacts
#   artifacts:
#     paths:
#       - maestro-artifacts/
#     when: always

# Step 5: server End-to-End Tests with Cypress
# server-e2e-cypress:
#   stage: e2e
#   image: cypress/included:12.6.0
#   script:
#     - cypress run --config-file cypress.json
#   artifacts:
#     paths:
#       - cypress/results/
#     when: always
